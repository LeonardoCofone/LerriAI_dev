<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LerriAI - Your Digital Strategic Assistant</title>
    <meta name="theme-color" content="#0827b0">
    <meta name="description" content="LerriAI - Your digital strategic AI assistant">
    <link rel="stylesheet" href="app.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="app.js" defer></script>
    <link rel="icon" href="icon/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="schedule-manager.css">
    <script src="schedule-manager.js"></script>
</head>
<body>
    <header>
        <h1 class="lexor">Lerri</h1>
        <nav>
            <ul id="nav-tabs">
                <li data-tab="chat" class="active" aria-current="page">
                    <span class="icon">üí¨</span>
                    <span class="tab-label">Chat</span>
                </li>
                <li data-tab="calendar">
                    <span class="icon">üìÖ</span>
                    <span class="tab-label">Calendar</span>
                </li>
                <li data-tab="tasks">
                    <span class="icon">‚úì</span>
                    <span class="tab-label">Tasks</span>
                </li>
                <li data-tab="settings">
                    <span class="icon">‚öôÔ∏è</span>
                    <span class="tab-label">Settings</span>
                </li>
            </ul>
        </nav>
    </header>  <!--,.jpg,.jpeg,.png,.gif,.webp-->

    <main>
        <section id="chat" class="tab-content active">
            <div class="chat-window">
                <div class="chat-header-bar">
                    <button id="clear-chat-btn" class="btn-icon" aria-label="Clear chat">
                        üóëÔ∏è
                    </button>
                </div>
                
                <div id="attached-files-display" class="attached-files-display hidden"></div>
                
                <div id="messages" class="messages">
                    <div class="welcome-message">
                        <h3>üëã Welcome to LerriAI!</h3>
                        <p>Your digital strategic AI assistant. Ask me anything!</p>
                    </div>
                </div>
                <form id="chat-form">
                    <input type="file" id="file-input" multiple accept=".pdf,.doc,.docx,.txt" style="display: none;">
                    
                    <button type="button" id="attach-btn" aria-label="Attach files">
                        üìé
                    </button>

                    <button type="button" id="mic-btn" aria-label="Use voice">
                        üé§
                    </button>

                    <textarea id="chat-input" placeholder="Ask Lerri..." rows="1" required></textarea>

                    <button type="submit" aria-label="Send message">
                        <span>‚û§</span>
                    </button>
                </form>
            </div>
        </section>

        <section id="calendar" class="tab-content">
            <div class="calendar-container">
                <div class="monthly-view" id="monthly-view">
                    <div class="calendar-header">
                        <button id="prev-month" aria-label="Previous month">‚Üê</button>
                        <h2 id="calendar-month">Month Year</h2>
                        <button id="next-month" aria-label="Next month">‚Üí</button>
                        <div class="calendar-actions">
                            <button id="import-google-calendar" class="btn-icon" aria-label="Import from Google Calendar" title="Import events">
                                üì•
                            </button>
                            <div class="info-tooltip">
                                <span class="info-icon">‚ÑπÔ∏è</span>
                                <div class="tooltip-content">
                                    Import all your future events from Google Calendar. 
                                    This will only READ you events from your google calendar, no original data will be modified.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="calendar-grid" class="calendar-grid">
                        <table>
                            <thead>
                                <tr>
                                    <th>Mon</th>
                                    <th>Tue</th>
                                    <th>Wed</th>
                                    <th>Thu</th>
                                    <th>Fri</th>
                                    <th>Sat</th>
                                    <th>Sun</th>
                                </tr>
                            </thead>
                            <tbody id="calendar-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="day-view hidden" id="day-view">
                    <div class="day-header">
                        <button id="back-to-month" aria-label="Back to calendar">‚Üê Back</button>
                        <h3 id="selected-date-title">Selected Date</h3>
                    </div>
                    
                    <div class="day-view-content">
                        <div class="day-events">
                            <h4>Day's Events</h4>
                            <ul id="day-event-list" class="event-list">
                                <li class="empty-state">No events for this day</li>
                            </ul>
                        </div>
                    <div class="day-form">
                        <h4>Add Event</h4>
                        <form id="day-event-form">
                            <input type="hidden" id="day-event-id">
                            
                            <div class="emoji-title-group" style="display: flex; flex-direction: column; align-items: center;">
                                <button type="button" id="event-emoji-select" class="btn-icon"
                                    style="
                                        font-size: 2rem;
                                        width: 70px;
                                        height: 70px;
                                        background: white;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        border: 2px solid #ddd;
                                    ">
                                    üïí
                                </button>

                                <input type="text" id="day-event-title" placeholder="Event title..." required>
                            </div>

                            
                            <textarea id="day-event-description" placeholder="Description (optional)" rows="2"></textarea>
                            
                            <div class="time-inputs">
                                <div class="input-group">
                                    <label for="day-event-start">Start</label>
                                    <input type="time" id="day-event-start">
                                </div>
                                <div class="input-group">
                                    <label for="day-event-end">End</label>
                                    <input type="time" id="day-event-end">
                                </div>
                            </div>

                            <div class="recurring-options">
                                <label>
                                    <input type="checkbox" id="event-recurring">
                                    Repeat this event every year for 5 years
                                </label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Save Event</button>
                                <button type="button" id="delete-day-event" class="btn-danger">Delete</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>  

        <section id="tasks" class="tab-content">
            <div class="tasks-container">
                <div class="tasks-header">
                    <h2>My Tasks</h2>
                    <button id="clear-completed" class="btn-secondary">Clear Completed</button>
                </div>
                
                <form id="task-form">
                    <div class="task-input-group">
                        <input type="text" id="task-title" placeholder="New task..." required>
                        <input type="time" id="task-time" placeholder="Time">
                        <button type="submit" class="btn-primary">Add</button>
                    </div>
                </form>
                
                <div class="task-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="active">Active</button>
                    <button class="filter-btn" data-filter="completed">Completed</button>
                </div>
                
                <div class="task-list-wrapper">
                    <ul id="task-list" class="task-list">
                        <li class="empty-state">No tasks. Start by adding one!</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="settings" class="tab-content">
            <div class="settings-card">
                <h2>üìÖ Recurring Timetable</h2>
                <p style="padding-bottom: 15px;">Manage your recurring weekly calendar</p>
                <button id="manage-schedule-btn" class="btn-primary">Manage Schedule</button>
            </div>
            <div id="schedule-modal" class="modal hidden">
                <div class="modal-content schedule-modal-content">
                    <div class="schedule-header">
                        <h3>üìÖ Change Recurring Schedule</h3>
                        <button id="close-schedule-modal" class="close-btn">√ó</button>
                    </div>

                    <!-- Progress Tabs -->
                    <div class="schedule-tabs">
                        <button class="schedule-tab-btn active" data-tab="schedule">üìö Orari Fissi</button>
                        <button class="schedule-tab-btn" data-tab="sports">‚öΩ Sport</button>
                        <button class="schedule-tab-btn" data-tab="hobbies">üé® Hobbies</button>
                    </div>

                    <!-- Tab: Schedule -->
                    <div class="schedule-tab-content active" id="schedule-tab">
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 10px;">
                                Name of the activity:
                            </label>
                            <input type="text" id="edit-activity-name" placeholder="es. Scuola, Lavoro, Universit√†" 
                                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem;">
                        </div>

                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 10px;">
                                Seleziona Orari (slot da 1 ora):
                            </label>
                            <div id="edit-week-calendar" style="display: grid; grid-template-columns: 60px repeat(7, 1fr); gap: 1px; background: #cbd5e0; border-radius: 10px; overflow: hidden;">
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 10px;">
                                Attivit√† Salvate:
                            </label>
                            <div id="edit-activities-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                            </div>
                        </div>

                        <button onclick="saveEditActivity()" class="btn-primary" style="width: 100%; margin-top: 15px;">
                            üíæ Salva Attivit√† Corrente
                        </button>
                    </div>

                    <!-- Tab: Sports -->
                    <div class="schedule-tab-content" id="sports-tab">
                        <div class="quick-items-grid">
                            <button class="quick-add-btn" onclick="addEditSport('Calcio', '‚öΩ')">
                                <span style="font-size: 2rem;">‚öΩ</span>
                                Calcio
                            </button>
                            <button class="quick-add-btn" onclick="addEditSport('Basket', 'üèÄ')">
                                <span style="font-size: 2rem;">üèÄ</span>
                                Basket
                            </button>
                            <button class="quick-add-btn" onclick="addEditSport('Nuoto', 'üèä')">
                                <span style="font-size: 2rem;">üèä</span>
                                Nuoto
                            </button>
                            <button class="quick-add-btn" onclick="addEditSport('Palestra', 'üí™')">
                                <span style="font-size: 2rem;">üí™</span>
                                Palestra
                            </button>
                            <button class="quick-add-btn" onclick="addEditSport('Yoga', 'üßò')">
                                <span style="font-size: 2rem;">üßò</span>
                                Yoga
                            </button>
                            <button class="quick-add-btn" onclick="addEditSport('Corsa', 'üèÉ')">
                                <span style="font-size: 2rem;">üèÉ</span>
                                Corsa
                            </button>
                        </div>

                        <div style="display: flex; gap: 15px; margin: 20px 0;">
                            <input type="text" id="custom-sport-name" placeholder="Aggiungi sport personalizzato..." 
                                style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;">
                            <button onclick="addCustomEditSport()" class="btn-primary">‚ûï Aggiungi</button>
                        </div>

                        <div id="edit-sports-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px;">
                        </div>
                    </div>

                    <!-- Tab: Hobbies -->
                    <div class="schedule-tab-content" id="hobbies-tab">
                        <div class="quick-items-grid">
                            <button class="quick-add-btn" onclick="addEditHobby('Leggere', 'üìö')">
                                <span style="font-size: 2rem;">üìö</span>
                                Leggere
                            </button>
                            <button class="quick-add-btn" onclick="addEditHobby('Pregare', 'üôè')">
                                <span style="font-size: 2rem;">üôè</span>
                                Pregare
                            </button>
                            <button class="quick-add-btn" onclick="addEditHobby('Meditare', 'üßò‚Äç‚ôÇÔ∏è')">
                                <span style="font-size: 2rem;">üßò‚Äç‚ôÇÔ∏è</span>
                                Meditare
                            </button>
                            <button class="quick-add-btn" onclick="addEditHobby('Suonare', 'üé∏')">
                                <span style="font-size: 2rem;">üé∏</span>
                                Suonare
                            </button>
                            <button class="quick-add-btn" onclick="addEditHobby('Disegnare', 'üé®')">
                                <span style="font-size: 2rem;">üé®</span>
                                Disegnare
                            </button>
                            <button class="quick-add-btn" onclick="addEditHobby('Scrivere', '‚úçÔ∏è')">
                                <span style="font-size: 2rem;">‚úçÔ∏è</span>
                                Scrivere
                            </button>
                        </div>

                        <div style="display: flex; gap: 15px; margin: 20px 0;">
                            <input type="text" id="custom-hobby-name" placeholder="Aggiungi hobby personalizzato..." 
                                style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;">
                            <button onclick="addCustomEditHobby()" class="btn-primary">‚ûï Aggiungi</button>
                        </div>

                        <div id="edit-hobbies-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px;">
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <div style="margin-bottom: 20px; padding: 15px; background: #eef2ff; border-radius: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; margin: 0; font-weight: normal;">
                                <input type="checkbox" id="edit-recur-forever" checked style="width: 20px; height: 20px;">
                                <span>Ripeti ogni settimana per 10 anni (consigliato)</span>
                            </label>
                        </div>

                        <div style="display: flex; gap: 15px;">
                            <button id="cancel-schedule" class="btn-secondary" style="flex: 1;">Annulla</button>
                            <button id="save-schedule" class="btn-primary" style="flex: 1;">üíæ Salva Modifiche</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-container">
                <div class="settings-card">
                    <h2>üí∞ AI Budget</h2>
                    <div class="budget-display">
                        <div class="budget-item">
                            <span class="label">Current Spend</span>
                            <span class="value">‚Ç¨<span id="current-spend">0.00</span></span>
                        </div>
                        <div class="budget-item">
                            <span class="label">Monthly Limit</span>
                            <span class="value">‚Ç¨<span id="max-spend-display">10.00</span></span>
                        </div>
                        <div class="progress-bar">
                            <div id="spend-progress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <form id="settings-form">
                        <label for="max-spend">Set Monthly Limit (‚Ç¨)</label>
                        <input type="number" id="max-spend" placeholder="e.g. 10" min="0" step="0.01" value="10">
                        
                        <label for="language-select">Language</label>
                        <select id="language-select">
                            <option value="it">Italiano</option>
                            <option value="en">English</option>
                            <option value="es">Espa√±ol</option>
                            <option value="fr">Fran√ßais</option>
                            <option value="de">Deutsch</option>
                            <option value="pt">Portugu√™s</option>
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="ja">Êó•Êú¨Ë™û</option>
                            <option value="zh">‰∏≠Êñá</option>
                            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        </select>

                        <label for="user-description">Personal Description</label>
                        <textarea id="user-description" placeholder="Tell me about yourself, your interests, goals..." rows="3"></textarea>

                        <div style="display: flex; align-items: center; gap: 10px; margin: 1rem 0;">
                            <input type="checkbox" id="daily-bible-verse" style="width: 20px; height: 20px; margin: 0;">
                            <label for="daily-bible-verse" style="margin: 0;">Daily Bible verse</label>
                        </div>
                        
                        <button type="submit" class="btn-primary">Save Settings</button>
                    </form>
                </div>

                <div class="settings-card">
                    <div class="model-info">
                        <p>Estimated cost for 1000 text messages: <strong>‚Ç¨<span id="model-cost">0.99‚Ç¨</span></strong></p>
                        <p>Estimated cost for 1 minute of vocal messages: <strong>‚Ç¨<span>0.006‚Ç¨</span></strong></p>
                    </div>
                </div>

                <div class="settings-card">
                    <h2>üìä Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Messages Sent</span>
                            <span class="stat-value" id="total-messages">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Events Created</span>
                            <span class="stat-value" id="total-events">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Tasks Completed</span>
                            <span class="stat-value" id="total-tasks">0</span>
                        </div>
                    </div>
                </div>
                <!-- Delete Account Modal -->
                <div class="settings-card">
                    <h2>‚öôÔ∏è Account</h2>
                    <div class="account-actions">
                        <button id="logout-btn" class="btn-secondary">Logout</button>
                        <button id="delete-account" class="btn-danger">Delete Account</button>
                    </div>
                </div>
                <div id="delete-modal" class="modal hidden">
                    <div class="modal-content">
                        <h3>‚ö†Ô∏è Confirm Account Deletion</h3>
                        <p>Are you sure you want to delete your account? <br>All your messages, tasks, events, and settings will be permanently deleted.<br>There is NO comeback</p>
                        <div class="modal-actions">
                            <button id="cancel-delete" class="btn-secondary">Cancel</button>
                            <button id="confirm-delete" class="btn-danger">Delete</button>
                        </div>
                    </div>
                </div>
                <div id="logout-modal" class="modal hidden">
                    <div class="modal-content">
                        <h3>üö™ Confirm Logout</h3>
                        <p>Are you sure you want to logout?<br>You will need to login again to access the app.</p>
                        <div class="modal-actions">
                            <button id="cancel-logout" class="btn-secondary">Cancel</button>
                            <button id="confirm-logout" class="btn-primary">Logout</button>
                        </div>
                    </div>
                </div>
                

            </div>
        </section>
        <div id="clear-chat-modal" class="modal hidden">
            <div class="modal-content">
                <h3>üóëÔ∏è Clear Chat History</h3>
                <p>Are you sure you want to delete all messages?<br>This action cannot be undone.</p>
                <div class="modal-actions">
                    <button id="cancel-clear-chat" class="btn-secondary">Cancel</button>
                    <button id="confirm-clear-chat" class="btn-danger">Clear All</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("./sw.js")
                    .then(reg => console.log("SW registrato con successo:", reg.scope))
                    .catch(err => console.error("Errore registrazione SW:", err));
            });
        }

        // === Gestione input chat ===
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");

        if (chatForm && chatInput) {
            // Invio con Enter, a capo con Shift+Enter
            chatInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.requestSubmit();
                }
            });

            // Auto-resize fino a 4 righe con scroll automatico
            chatInput.addEventListener("input", function () {
                this.style.height = "auto";
                const lineHeight = parseInt(window.getComputedStyle(this).lineHeight);
                const maxHeight = lineHeight * 4;
                this.style.overflowY = this.scrollHeight > maxHeight ? "auto" : "hidden";
                this.style.height = Math.min(this.scrollHeight, maxHeight) + "px";

                // scroll sempre all'ultima riga
                this.scrollTop = this.scrollHeight;
            });
        }

    

function loadCurrentSchedule() {
    editScheduleBlocks = {};
    editCurrentSelection = new Set();
    editSportsActivities = [];
    editHobbiesActivities = [];
    
    // Carica dalla configurazione corrente
    if (settings.schedule && settings.schedule.subjects) {
        settings.schedule.subjects.forEach((subject, index) => {
            if (subject.hasTime && subject.days && subject.days.length > 0) {
                const blocks = [];
                subject.days.forEach(day => {
                    blocks.push({
                        day: day,
                        time: subject.startTime
                    });
                });
                editScheduleBlocks[index] = {
                    name: subject.name,
                    blocks: blocks
                };
            }
        });
    }

    if (settings.schedule && settings.schedule.sports) {
        editSportsActivities = settings.schedule.sports.map(s => ({
            name: s.name,
            emoji: s.emoji || '‚öΩ'
        }));
    }

    if (settings.schedule && settings.schedule.hobbies) {
        editHobbiesActivities = settings.schedule.hobbies.map(h => ({
            name: h.name,
            emoji: h.emoji || 'üé®'
        }));
    }

    renderEditActivities();
    renderEditSports();
    renderEditHobbies();
}


function toggleEditCell(key, cell) {
    if (editCurrentSelection.has(key)) {
        editCurrentSelection.delete(key);
        cell.style.background = 'white';
        cell.innerHTML = '';
    } else {
        editCurrentSelection.add(key);
        cell.style.background = '#667eea';
        cell.innerHTML = '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1.2rem; font-weight: bold;">‚úì</div>';
    }
}

function saveEditActivity() {
    if (editCurrentSelection.size === 0) {
        alert('Seleziona almeno una cella del calendario');
        return;
    }

    const activityName = document.getElementById('edit-activity-name').value.trim() || 'Attivit√†';
    const blocks = Array.from(editCurrentSelection).map(key => {
        const [day, time] = key.split('-');
        return { day, time };
    });

    const activityId = Date.now();
    editScheduleBlocks[activityId] = {
        name: activityName,
        blocks: blocks
    };

    renderEditActivities();
    editCurrentSelection.clear();
    generateEditCalendar();
    document.getElementById('edit-activity-name').value = '';
}

function renderEditActivities() {
    const list = document.getElementById('edit-activities-list');
    if (!list) return;

    list.innerHTML = '';

    Object.entries(editScheduleBlocks).forEach(([id, activity]) => {
        const tag = document.createElement('div');
        tag.className = 'activity-tag-edit';
        tag.innerHTML = `
            <span>üìö ${activity.name} (${activity.blocks.length} slot)</span>
            <button onclick="removeEditActivity(${id})">√ó</button>
        `;
        list.appendChild(tag);
    });
}

function removeEditActivity(id) {
    delete editScheduleBlocks[id];
    renderEditActivities();
}

function addEditSport(name, emoji) {
    editSportsActivities.push({ name, emoji });
    renderEditSports();
}

function addCustomEditSport() {
    const input = document.getElementById('custom-sport-name');
    const name = input.value.trim();
    if (name) {
        editSportsActivities.push({ name, emoji: '‚öΩ' });
        input.value = '';
        renderEditSports();
    }
}

function renderEditSports() {
    const list = document.getElementById('edit-sports-list');
    if (!list) return;

    list.innerHTML = '';

    editSportsActivities.forEach((sport, index) => {
        const tag = document.createElement('div');
        tag.className = 'activity-tag-edit';
        tag.innerHTML = `
            <span>${sport.emoji} ${sport.name}</span>
            <button onclick="removeEditSport(${index})">√ó</button>
        `;
        list.appendChild(tag);
    });
}

function removeEditSport(index) {
    editSportsActivities.splice(index, 1);
    renderEditSports();
}

function addEditHobby(name, emoji) {
    editHobbiesActivities.push({ name, emoji });
    renderEditHobbies();
}

function addCustomEditHobby() {
    const input = document.getElementById('custom-hobby-name');
    const name = input.value.trim();
    if (name) {
        editHobbiesActivities.push({ name, emoji: 'üé®' });
        input.value = '';
        renderEditHobbies();
    }
}

function renderEditHobbies() {
    const list = document.getElementById('edit-hobbies-list');
    if (!list) return;

    list.innerHTML = '';

    editHobbiesActivities.forEach((hobby, index) => {
        const tag = document.createElement('div');
        tag.className = 'activity-tag-edit';
        tag.innerHTML = `
            <span>${hobby.emoji} ${hobby.name}</span>
            <button onclick="removeEditHobby(${index})">√ó</button>
        `;
        list.appendChild(tag);
    });
}

function removeEditHobby(index) {
    editHobbiesActivities.splice(index, 1);
    renderEditHobbies();
}

function convertEditToScheduleFormat() {
    const scheduleByDayTime = {};

    Object.values(editScheduleBlocks).forEach(activity => {
        activity.blocks.forEach(block => {
            const key = `${block.day}-${block.time}`;
            if (!scheduleByDayTime[key]) {
                scheduleByDayTime[key] = [];
            }
            scheduleByDayTime[key].push(activity.name);
        });
    });

    // Unifica eventi consecutivi
    const consolidatedActivities = {};
    const processedBlocks = new Set();

    Object.entries(scheduleByDayTime).forEach(([key, names]) => {
        if (processedBlocks.has(key)) return;

        const [day, time] = key.split('-');
        const [hours] = time.split(':').map(Number);
        const activityName = names[0];

        let endHour = hours + 1;

        // Cerca blocchi consecutivi
        let keepLooking = true;
        while (keepLooking) {
            const nextTimeStr = `${String(endHour).padStart(2, '0')}:00`;
            const nextKey = `${day}-${nextTimeStr}`;
            
            if (scheduleByDayTime[nextKey] && scheduleByDayTime[nextKey][0] === activityName) {
                processedBlocks.add(nextKey);
                endHour++;
            } else {
                keepLooking = false;
            }
        }

        processedBlocks.add(key);

        if (!consolidatedActivities[activityName]) {
            consolidatedActivities[activityName] = [];
        }

        consolidatedActivities[activityName].push({
            day,
            start: time,
            end: `${String(endHour).padStart(2, '0')}:00`
        });
    });

    const subjects = [];
    Object.entries(consolidatedActivities).forEach(([name, timeBlocks]) => {
        timeBlocks.forEach(timeBlock => {
            subjects.push({
                name: name,
                days: [timeBlock.day],
                startTime: timeBlock.start,
                endTime: timeBlock.end,
                hasTime: true
            });
        });
    });

    const sportsData = editSportsActivities.map(sport => ({
        name: sport.name,
        emoji: sport.emoji,
        days: [],
        hasTime: false
    }));

    const hobbiesData = editHobbiesActivities.map(hobby => ({
        name: hobby.name,
        emoji: hobby.emoji,
        days: [],
        hasTime: false
    }));

    return {
        work: null,
        subjects: subjects,
        sports: sportsData,
        hobbies: hobbiesData
    };
}



// Hamburger menu per mobile
const hamburger = document.createElement('button');
hamburger.id = 'hamburger-btn';
hamburger.innerHTML = '‚ò∞';
hamburger.setAttribute('aria-label', 'Menu');
document.querySelector('header').insertBefore(hamburger, document.querySelector('nav'));

const nav = document.querySelector('nav');
hamburger.addEventListener('click', () => {
    nav.classList.toggle('open');
});

// Chiudi menu quando clicco su un tab
document.querySelectorAll('#nav-tabs li').forEach(tab => {
    tab.addEventListener('click', () => {
        nav.classList.remove('open');
    });
});

// Chiudi menu quando clicco fuori
document.addEventListener('click', (e) => {
    if (!nav.contains(e.target) && !hamburger.contains(e.target) && nav.classList.contains('open')) {
        nav.classList.remove('open');
    }
});

</script>


<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>
</body>
</html>
